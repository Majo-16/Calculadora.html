function responderChat() {
  const input = document.getElementById('chat-question');
  const msg = input.value;
  if (!msg.trim()) return;
  const body = document.getElementById('chatbot-body');
  body.innerHTML += `<p><strong>TÃº:</strong> ${msg}</p>`;

  let respuesta = 'Hmm... No estoy seguro, pero puedo ayudarte a graficar funciones.';
  if (msg.toLowerCase().includes('dominio')) respuesta = 'El dominio es el conjunto de valores de x permitidos.';
  if (msg.toLowerCase().includes('rango')) respuesta = 'El rango es el conjunto de valores posibles de f(x).';
  if (msg.toLowerCase().includes('cÃ³mo resolver')) respuesta = 'Puedes escribir la funciÃ³n y hacer clic en "Calcular".';

  body.innerHTML += `<p><strong>MajoBot:</strong> ${respuesta}</p>`;
  body.scrollTop = body.scrollHeight;
  input.value = '';
}

function calcular() {
  const input = document.getElementById('funcion').value.replace(/\s/g, '');
  const match = input.match(/(.+)(<=|>=|<|>)(.+)/);
  let exprText, operator = null, compareText = null;

  if (match) {
    exprText = match[1];
    operator = match[2];
    compareText = match[3];
  } else {
    exprText = input;
  }

  const expr = math.parse(exprText);
  const f = expr.compile();
  const g = compareText ? math.parse(compareText).compile() : null;

  let x_vals = [], y_vals = [], valid_x = [], valid_y = [];
  let minY = Infinity, maxY = -Infinity, domain = [];

  for (let x = -50; x <= 50; x += 0.1) {
    try {
      let scope = { x };
      let y = f.evaluate(scope);
      let gy = g ? g.evaluate(scope) : 0;

      if (typeof y === 'number' && isFinite(y)) {
        x_vals.push(x);
        y_vals.push(y);
        domain.push(x);
        if (y < minY) minY = y;
        if (y > maxY) maxY = y;

        if (operator) {
          let valid = false;
          if (operator === '>') valid = y > gy;
          if (operator === '>=') valid = y >= gy;
          if (operator === '<') valid = y < gy;
          if (operator === '<=') valid = y <= gy;
          valid_x.push(x);
          valid_y.push(valid ? y : null);
        }
      }
    } catch {}
  }

  const traces = [
    {
      x: x_vals,
      y: y_vals,
      mode: 'lines',
      name: 'f(x)',
      line: { color: '#0d6efd', width: 2 }
    }
  ];

  if (operator) {
    traces.push({
      x: valid_x,
      y: valid_y,
      fill: 'tozeroy',
      mode: 'lines',
      name: 'Zona vÃ¡lida',
      line: { color: 'rgba(13,110,253,0.2)' },
      fillcolor: 'rgba(13,110,253,0.3)'
    });
  }

  Plotly.newPlot('plot', traces, {
    title: 'GrÃ¡fica',
    xaxis: { title: 'x' },
    yaxis: { title: 'f(x)' },
    margin: { t: 30 }
  });

  let salida = `
    <p>ðŸ“Œ <strong>Dominio:</strong> <span class="math">[${Math.min(...domain).toFixed(2)}, ${Math.max(...domain).toFixed(2)}]</span></p>
    <p>ðŸ“ˆ <strong>Rango:</strong> <span class="math">[${minY.toFixed(2)}, ${maxY.toFixed(2)}]</span></p>
  `;

  if (operator) {
    salida += `<p>âœ… <strong>SoluciÃ³n grÃ¡fica:</strong> <span class="math">${exprText} ${operator} ${compareText}</span></p>`;
  }

  const output = document.getElementById('output');
  output.style.display = 'block';
  output.innerHTML = salida;
}
