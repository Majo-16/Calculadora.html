<script>
  function calcular() {
    const input = document.getElementById('funcion').value.trim();
    if (!input) return alert("‚ö†Ô∏è Ingresa una funci√≥n v√°lida.");

    const match = input.match(/(.+)(<=|>=|<|>)(.+)/);
    let exprText, operator = null, compareText = null;

    if (match) {
      exprText = match[1];
      operator = match[2];
      compareText = match[3];
    } else {
      exprText = input;
    }

    let expr, f, g = null;
    try {
      expr = math.parse(exprText);
      f = expr.compile();
    } catch {
      return alert("‚ùå Error al interpretar la funci√≥n: " + exprText);
    }

    if (compareText) {
      try {
        g = math.parse(compareText).compile();
      } catch {
        return alert("‚ùå Error al interpretar la comparaci√≥n: " + compareText);
      }
    }

    let x_vals = [], y_vals = [], valid_x = [], valid_y = [];
    let minY = Infinity, maxY = -Infinity, domain = [];

    for (let x = -50; x <= 50; x += 0.1) {
      try {
        const scope = { x };
        const y = f.evaluate(scope);
        const gy = g ? g.evaluate(scope) : 0;

        if (typeof y === 'number' && isFinite(y)) {
          x_vals.push(x);
          y_vals.push(y);
          domain.push(x);
          if (y < minY) minY = y;
          if (y > maxY) maxY = y;

          if (operator) {
            let valid = false;
            if (operator === '>') valid = y > gy;
            if (operator === '>=') valid = y >= gy;
            if (operator === '<') valid = y < gy;
            if (operator === '<=') valid = y <= gy;

            if (valid) {
              valid_x.push(x);
              valid_y.push(y);
            }
          }
        }
      } catch {
        // Saltar valores inv√°lidos
      }
    }

    const traces = [
      {
        x: x_vals,
        y: y_vals,
        mode: 'lines',
        name: 'f(x)',
        line: { color: '#0d6efd', width: 2 }
      }
    ];

    if (operator) {
      traces.push({
        x: valid_x,
        y: valid_y,
        fill: 'tozeroy',
        mode: 'lines',
        name: 'Zona v√°lida',
        line: { color: 'rgba(13,110,253,0.2)' },
        fillcolor: 'rgba(13,110,253,0.3)'
      });
    }

    Plotly.newPlot('plot', traces, {
      title: 'Gr√°fica',
      xaxis: { title: 'x' },
      yaxis: { title: 'f(x)' },
      margin: { t: 30 }
    });

    let salida = `
      <p>üìå <strong>Dominio:</strong> <span class="math">[${Math.min(...domain).toFixed(2)}, ${Math.max(...domain).toFixed(2)}]</span></p>
      <p>üìà <strong>Rango:</strong> <span class="math">[${minY.toFixed(2)}, ${maxY.toFixed(2)}]</span></p>
    `;

    if (operator) {
      salida += `<p>‚úÖ <strong>Soluci√≥n gr√°fica:</strong> <span class="math">${exprText} ${operator} ${compareText}</span></p>`;
    }

    const output = document.getElementById('output');
    output.style.display = 'block';
    output.innerHTML = salida;
  }
</script>
